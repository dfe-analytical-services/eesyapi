---
title: "EES API workflow"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{EES API workflow}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
  
)
if(!require("eesyapi")) {
  devtools::load_all(".")
}
```

```{r setup}
```

The following article presents an example workflow of how, as an analyst, someone might
connect to the explore education statistics (EES) API to collect data with the help of
`eesyapi` in R.

As an overview, the stages you will likely need to follow are:

- Find the data set ID
- Query the data set meta data to identify filter and indicator IDs
- Design a query using the relevant IDs
- Post the query to the API
- Perform some post processing of the data

## Finding a data set ID

Only some data sets on EES are available via the EES API. This is to maintain 
minimum standards around the API data catalogue.

Assuming you know the data set within a publication that you would like to query, 
you will first need to identify the data set ID code. There are two methods to do 
this, either a) via the data set's page on the EES website or b) by querying the 
API itself.

### Identifying a data set ID via the API

Finding a data set ID via the API is a two step process. First, you'll need to find the parent publication ID and second, you'll need to search the data catalogue within that publication for the data set.

Querying the publication list:

```
eesyapi::get_publications()
```

This returns a list of all publications by id and title (along with slug, summary and date last published). 
From this list, you can find the title of the publication that you're interested in and pick out the 
associated publication ID.

For example from the test list, we can pick out **"Attendance API data"**, which has an 
id of **"b6d9ed96-be68-4791-abc3-08dcaba68c04"**. We can now use this in the function `eesyapi::get_data_catalogue()` to find all the data sets within that publication:

```
eesyapi::get_data_catalogue("b6d9ed96-be68-4791-abc3-08dcaba68c04")
```

This returns a data frame containing data set ids and titles (along with a summary, the status and information on what's in the latest version). The data set ids can be used as shown in the following sections to get a given data set's summary and meta data, and to query the data set itself.

### Finding a data set ID on the EES website

As with any other data set, you can find an API data set in the EES data catalogue. If you
know the name, you can filter the catalogue on this as normal. Not all data sets are accessible via the API, so to filter down to just those that are, click the **"API data sets only"** option as shown in the image below.

![Finding an API data set in the EES data catalogue](ees-data-catalogue-find-api-data-set.png)

Once you've found the data set you need, then click on the title of the data set to be 
taken to it's details page in the catalogue. On this page (pictured below), you'll find the **API data set quick start** section, which gives the API data set name, **API data set ID** and API data set version. This **API data set ID** is what's needed below to query the data set and its meta data.

![An example of an API data set's details](ees-data-catalogue-details-api-data-set.png)

## Getting the data set meta data

When querying a data set via the API, indicator and filter items are referenced 
using auto-generated ID codes (known as SQIDs). Therefore, in order to construct a query that 
involves selecting a subset of filter items or indicators, you'll need to obtain
the codes associated with those elements.

All those filter item and indicator codes are stored in a data set's meta data, 
which can also be queried via the API. To get those codes as well as details on
what time periods and geographic levels and locations are available in a given
data set, you can use the function `eesyapi::get_meta()`, providing it with your 
data set's ID (which you can obtain either using `eesyapi::get_data_catalogue()` or via
the EES data catalogue). For example, to get the "attendance in schools" data from the example
attendance API data publication, you can take the data set ID 
`7c0e9201-c7c0-ff73-bee4-304e731ec0e6` and provide it as a parameter to `get_meta`:

```
eesyapi::get_meta(dataset_id = "7c0e9201-c7c0-ff73-bee4-304e731ec0e6")
```

This function returns a list of 5 data frames:

- `$time_periods`: label, code and period of all available time periods in the data set
- `$locations`: geographic_level, code, label and item_id of all available locations in the data set
- `$filter_columns`: col_name and label of all filters in the data set
- `$filter_items`: col_name, item_label, item_id and default_item for all filter items in the data set
- `$indicators`: col_name and label of all indicators in the data set

The item_id values provided in `$locations` and `$filter_items` are required to 
construct queries for filtering a given data set, whilst time periods can be 
filtered on the values in the `$time_period` code column.

In this example, let's say we've run `eesyapi::get_meta("7c0e9201-c7c0-ff73-bee4-304e731ec0e6")`
and we want to filter our data set to obtain data for:

- the "Week 51" time period, 
- "York" and "England" from the locations,
- "Absence" from Attendance status
- "Approved educational activity", "Authorised" and "Unauthorised" from Attendance type
- And we want to see "Number of sessions" data values.

For this we would need the following codes / item_ids:

- "W51"
- "jfhAM" and "dP0Zw"
- "7SdXo"
- "6AXrf", "0k3T5" and "YdkHK"
- "bqZtT"

Note that whilst the above IDs are unique within a given item type (e.g. `filter_item`), they are
not necessarily unique between types. For example, a given `indicator` could be assigned the same 
ID as a `filter_item` in a given data set.

As a quick example of how you might quickly query the meta data for these codes, you could try the
following example pieces of query code.

### Time periods

``` {r}
eesyapi::get_meta(dataset_id = "7c0e9201-c7c0-ff73-bee4-304e731ec0e6") |>
  magrittr::extract2("time_periods") |>
  dplyr::filter(
    label %in% c("2023 Week 51")
  )
```

### Locations
``` {r}
eesyapi::get_meta(dataset_id = "7c0e9201-c7c0-ff73-bee4-304e731ec0e6") |>
  magrittr::extract2("locations") |>
  dplyr::filter(label %in% c("York", "England"))
```

### Filter items

``` {r}
eesyapi::get_meta(dataset_id = "7c0e9201-c7c0-ff73-bee4-304e731ec0e6") |>
  magrittr::extract2("filter_items") |>
  dplyr::filter(
    item_label %in% c("Absence", "Approved educational activity", "Authorised", "Unauthorised")
  )
```

### Indicators

``` {r}
eesyapi::get_meta(dataset_id = "7c0e9201-c7c0-ff73-bee4-304e731ec0e6") |>
  magrittr::extract2("indicators") |>
  dplyr::filter(
    label %in% c("Session count")
  )
```

## Posting a query of a data set

We'll now use the element item_ids from the meta data to build queries of the data set.


### Get the entirety of a single data set

### Post a simple query of a single data set

### Post a more complex query of a single data set

## Useful notes on handling the data once you've got it

## FAQs

### Are there any bandwidth / repeat connection constraints that I should know about?

### Why do you use IDs rather than the actual labels used in the data?



